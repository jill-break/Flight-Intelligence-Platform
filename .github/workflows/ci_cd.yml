name: Flight Intelligence Platform CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  # ─────────────────────────────────────────────
  # Job 1 — Lint & Test (Multi-Python Matrix)
  # ─────────────────────────────────────────────
  lint-and-test:
    name: Lint & Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ['3.10', '3.11']

    steps:
      # 1. Checkout repo content
      - name: Checkout repo content
        uses: actions/checkout@v6

      # 2. Set up Python environment
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      # 3. Install required packages
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 pytest-cov

      # 4. Lint with flake8
      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Treat all other issues as warnings (exit-zero so the build continues)
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      # 5. Validate Pandera schema against generated sample data
      - name: Validate schema against sample data
        run: |
          python -c "
          import sys; sys.path.insert(0, '.')
          from scripts.flight_generator import generate_flight_data
          from spark.schemas.flight_schema import FlightSchema
          df = generate_flight_data(20, inject_dirty=False)
          FlightSchema.validate(df, lazy=True)
          print('Schema validation passed on 20 sample records')
          "

      # 6. Run test suite with coverage
      - name: Run tests with coverage
        run: |
          python -m pytest tests/ -v --tb=short -W ignore::DeprecationWarning \
            --cov=scripts --cov=spark/schemas --cov=airflow/dags \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml

      # 7. Upload coverage report
      - name: Upload coverage report
        if: matrix.python-version == '3.11'
        uses: actions/upload-artifact@v6
        with:
          name: coverage-report
          path: coverage.xml

  # ─────────────────────────────────────────────
  # Job 2 — Docker Build Validation
  # ─────────────────────────────────────────────
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: lint-and-test

    steps:
      - name: Checkout repo content
        uses: actions/checkout@v6

      - name: Build Docker image
        run: |
          docker build -t flight-intelligence-platform:ci .
